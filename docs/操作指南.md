# SHIB 风格 Meme 代币项目 - 快速操作指南

## � 快速开始

### 1. 项目克隆和安装

```bash
# 克隆项目
git clone <your-repo-url>
cd meme_task

# 安装依赖
npm install
```

### 2. 环境配置

创建 `.env` 文件：

```bash
# 私钥 (不要提交到版本控制)
PRIVATE_KEY=your_private_key_here

# RPC端点
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/your-project-id
MAINNET_RPC_URL=https://mainnet.infura.io/v3/your-project-id

# API密钥
ETHERSCAN_API_KEY=your_etherscan_api_key
```

### 3. 运行测试

```bash
# 编译合约
npx hardhat compile

# 运行所有测试
npm test

# 运行特定测试
npm test -- --grep "税机制"
```

### 4. 本地部署测试

```bash
# 启动本地区块链
npx hardhat node

# 新终端窗口 - 部署到本地网络
npm run deploy:localhost
```

### 5. 测试网部署

```bash
# 部署到Sepolia测试网
npm run deploy:sepolia
```

## 📊 项目特性

### 代币经济学
- **代币名称**: ShibaInu Simple (SHIBAS)
- **总供应量**: 1,000,000,000 (10亿)
- **买入税**: 3%
- **卖出税**: 5%
- **交易限制**: 单笔最大1%供应量，钱包最大2%供应量

### 安全特性
- ✅ 交易频率限制
- ✅ 黑名单管理  
- ✅ 可暂停交易
- ✅ 管理员权限控制
- ✅ 重入攻击防护

### 测试覆盖
- ✅ 25个测试用例100%通过
- ✅ 覆盖所有核心功能
- ✅ 边界条件测试
- ✅ 权限测试

## 🔧 核心功能使用

### 管理员操作

```javascript
// 启用交易
await shibToken.enableTrading();

// 更新税率 (最大买入税10%，卖出税15%)
await shibToken.updateTaxes(3, 5); // 3%买入，5%卖出

// 更新交易限制
await shibToken.updateTransactionLimits(
    ethers.parseEther("1000000"), // 单笔限制
    ethers.parseEther("2000000")  // 钱包限制
);

// 黑名单管理
await shibToken.addToBlacklist(badAddress);
await shibToken.removeFromBlacklist(badAddress);

// 设置免税地址
await shibToken.excludeFromFees(address, true);

// 设置免限制地址
await shibToken.excludeFromLimits(address, true);
```

### 查询功能

```javascript
// 获取账户统计
const stats = await shibToken.getAccountStats(userAddress);
console.log("余额:", ethers.formatEther(stats.balance));
console.log("是否免税:", stats.isExcludedFromFees_);

// 获取限制信息
const limits = await shibToken.getLimitsInfo();
console.log("交易已启用:", limits.tradingEnabled_);
console.log("冷却时间:", limits.transactionCooldown_);

// 获取池统计
const poolStats = await poolManager.getPoolStats();
console.log("总提供者:", poolStats.totalProviders_);
console.log("奖励率:", poolStats.currentRewardRate, "%");
```

## 🛠️ 常见问题解决

### 1. 测试失败

**问题**: 买入税测试失败
```bash
AssertionError: expected 1000 to equal 970
```

**解决**: 确保测试地址不被排除在税费之外
```javascript
await shibToken.excludeFromFees(addr3.address, false);
await shibToken.excludeFromFees(addr1.address, false);
```

### 2. 部署失败

**问题**: "Max transaction too low"
```bash
Error: VM Exception while processing transaction: reverted with reason string 'Max transaction too low'
```

**解决**: 设置的限制必须满足最小值要求
```javascript
// 最小值：总供应量的0.1%和0.5%
const minMaxTx = totalSupply * 1n / 1000n;      // 0.1%
const minMaxWallet = totalSupply * 5n / 1000n;  // 0.5%
```

### 3. 权限错误

**问题**: "OwnableUnauthorizedAccount"
```bash
Error: VM Exception while processing transaction: reverted with custom error 'OwnableUnauthorizedAccount'
```

**解决**: 确保使用合约所有者账户调用管理员函数
```javascript
// 使用部署合约的账户
await shibToken.connect(owner).enableTrading();
```

## 📁 文件结构

```
meme_task/
├── contracts/shib/
│   ├── ShibaInuSimple.sol              # 主代币合约
│   └── LiquidityPoolManagerSimple.sol # 流动性管理
├── test/
│   └── ShibaInuSimple.test.js          # 测试套件
├── scripts/
│   └── deploy.js                       # 部署脚本
├── docs/
│   ├── PROJECT_DEVELOPMENT_LOG.md      # 开发记录
│   ├── TECHNICAL_IMPLEMENTATION.md    # 技术实现
│   └── 操作指南.md                     # 本文档
├── hardhat.config.js                  # Hardhat配置
├── package.json                       # 依赖管理
└── .env                              # 环境变量
```

## 🎯 下一步行动

### 开发者
1. 阅读 `PROJECT_DEVELOPMENT_LOG.md` 了解开发过程
2. 查看 `TECHNICAL_IMPLEMENTATION.md` 了解技术细节
3. 运行测试确保环境正确
4. 在测试网部署和测试

### 部署者
1. 配置 `.env` 环境变量
2. 在测试网充分测试
3. 准备主网部署参数
4. 执行主网部署

### 用户
1. 了解代币经济学模型
2. 注意交易限制和税费
3. 参与流动性提供获得奖励

## � 技术支持

如遇到问题，请检查：
1. ✅ 依赖是否正确安装
2. ✅ 环境变量是否配置
3. ✅ 网络连接是否正常
4. ✅ 账户是否有足够余额

**项目状态**: 🟢 完成开发，已通过全面测试，可投入使用

---

*快速指南更新时间：2025年10月1日*
# 安装依赖
npm install

# 编译合约
npx hardhat compile

# 运行测试
npx hardhat test
```

### 网络配置

在 `hardhat.config.js` 中配置网络：

```javascript
module.exports = {
  networks: {
    mainnet: {
      url: "https://mainnet.infura.io/v3/YOUR_PROJECT_ID",
      accounts: ["YOUR_PRIVATE_KEY"]
    },
    goerli: {
      url: "https://goerli.infura.io/v3/YOUR_PROJECT_ID",
      accounts: ["YOUR_PRIVATE_KEY"]
    }
  }
};
```

### 部署命令

```bash
# 部署到本地网络
npx hardhat run scripts/deploy.js --network localhost

# 部署到测试网
npx hardhat run scripts/deploy.js --network goerli

# 部署到主网
npx hardhat run scripts/deploy.js --network mainnet
```

### 部署后验证

部署成功后，您将看到类似输出：

```
📋 合约部署总结
============================================================
🪙 ShibaInu Token:        0x1234567890123456789012345678901234567890
🏪 Uniswap V2 Pair:      0x0987654321098765432109876543210987654321
💧 Pool Manager:         0x1111222233334444555566667777888899990000
🔗 Uniswap V2 Router:    0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D
============================================================
```

## 📖 使用指南

### 1. 启用交易

首先需要启用交易功能：

```javascript
// 连接到已部署的合约
const shibToken = await ethers.getContractAt("ShibaInu", CONTRACT_ADDRESS);

// 启用交易（仅限所有者）
await shibToken.enableTrading();
```

### 2. 添加初始流动性

在 Uniswap 上添加初始流动性：

```javascript
// 1. 授权代币给 Uniswap 路由器
const tokenAmount = ethers.utils.parseEther("500000000"); // 5亿代币
await shibToken.approve(UNISWAP_ROUTER_ADDRESS, tokenAmount);

// 2. 在 Uniswap 网站上添加流动性
// 访问 https://app.uniswap.org/#/add/ETH/[您的代币地址]
// 或使用路由器合约直接添加
```

### 3. 代币交易

#### 普通转账
```javascript
// 普通转账不收取税费
const amount = ethers.utils.parseEther("1000");
await shibToken.transfer(recipientAddress, amount);
```

#### 通过 Uniswap 交易
```javascript
// 在 Uniswap 上买入/卖出会收取相应税费
// 买入: 3% 税费
// 卖出: 5% 税费
```

### 4. 流动性管理

使用流动性池管理合约：

```javascript
const poolManager = await ethers.getContractAt("LiquidityPoolManager", POOL_MANAGER_ADDRESS);

// 添加流动性
const tokenAmount = ethers.utils.parseEther("10000");
const ethAmount = ethers.utils.parseEther("1");

await shibToken.approve(poolManager.address, tokenAmount);
await poolManager.addLiquidity(
    tokenAmount,
    tokenAmount.mul(95).div(100), // 5% 滑点
    ethAmount.mul(95).div(100),
    { value: ethAmount }
);

// 移除流动性
const lpTokens = ethers.utils.parseEther("100");
await poolManager.removeLiquidity(
    lpTokens,
    0, // 最小代币数量
    0  // 最小 ETH 数量
);

// 提取奖励
await poolManager.claimRewards();
```

### 5. 查询功能

```javascript
// 获取账户统计信息
const stats = await shibToken.getAccountStats(userAddress);
console.log("余额:", ethers.utils.formatEther(stats.balance));
console.log("是否免税:", stats.isExcludedFromFees_);

// 获取税率信息
const taxInfo = await shibToken.getTaxInfo();
console.log("买入税:", taxInfo.buyTax_, "%");
console.log("卖出税:", taxInfo.sellTax_, "%");

// 获取限制信息
const limitsInfo = await shibToken.getLimitsInfo();
console.log("最大交易额:", ethers.utils.formatEther(limitsInfo.maxTransactionAmount_));
console.log("交易已启用:", limitsInfo.tradingEnabled_);

// 获取流动性提供者信息
const providerInfo = await poolManager.getProviderInfo(userAddress);
console.log("LP 代币:", ethers.utils.formatEther(providerInfo.lpTokens));
console.log("待领奖励:", ethers.utils.formatEther(providerInfo.pendingRewards));
```

## ⚙️ 管理员操作

### 税率管理

```javascript
// 更新税率（买入税、卖出税、流动性税、营销税、销毁税）
await shibToken.updateTaxes(2, 4, 1, 2, 1);

// 更新税费钱包
await shibToken.updateTaxWallets(newLiquidityWallet, newMarketingWallet);
```

### 交易限制管理

```javascript
// 更新交易限制
const newMaxTx = ethers.utils.parseEther("5000000");    // 500万代币
const newMaxWallet = ethers.utils.parseEther("20000000"); // 2000万代币
await shibToken.updateTransactionLimits(newMaxTx, newMaxWallet);

// 更新交易冷却时间（秒）
await shibToken.updateTransactionCooldown(60); // 1分钟

// 更新每日交易次数限制
await shibToken.updateMaxDailyTransactions(20);

// 黑名单管理
await shibToken.updateBlacklist(maliciousAddress, true); // 加入黑名单
await shibToken.updateBlacklist(addressToUnban, false);  // 移出黑名单
```

### 免税和免限制地址

```javascript
// 设置免税地址
await shibToken.excludeFromFees(exchangeAddress, true);

// 设置免限制地址
await shibToken.excludeFromLimits(institutionalAddress, true);
```

### 流动性池管理

```javascript
// 更新流动性池费用
await poolManager.updateFees(100, 150); // 1%, 1.5%

// 更新奖励率
await poolManager.updateRewardRate(15); // 15% APY

// 设置自动兑换阈值
const swapThreshold = ethers.utils.parseEther("50000"); // 5万代币
await shibToken.updateSwapTokensAtAmount(swapThreshold);

// 启用/禁用自动添加流动性
await shibToken.setSwapAndLiquifyEnabled(true);
```

### 紧急功能

```javascript
// 紧急提取 ETH
await shibToken.emergencyWithdrawETH();

// 紧急提取代币
await shibToken.emergencyWithdrawTokens(tokenAddress, amount);

// 流动性池紧急提取
await poolManager.emergencyWithdraw(tokenAddress, amount);
```

## 🛡️ 安全考虑

### 权限控制
- 大部分管理功能仅限所有者调用
- 使用 OpenZeppelin 的 `Ownable` 合约
- 重要功能具有参数验证

### 防攻击机制
- **重入攻击**: 使用 `ReentrancyGuard`
- **MEV 攻击**: 交易频率限制
- **大额交易**: 金额限制和反鲸鱼税
- **价格操纵**: 交易限制和黑名单

### 最佳实践
1. 定期监控合约状态
2. 合理设置税率和限制
3. 谨慎管理黑名单
4. 备份重要密钥
5. 定期安全审计

## 🔧 故障排除

### 常见问题

#### 1. 交易失败："Trading not yet enabled"
**解决方案**: 调用 `enableTrading()` 启用交易

```javascript
await shibToken.enableTrading();
```

#### 2. 交易失败："Transfer amount exceeds the maxTransactionAmount"
**解决方案**: 减少转账金额或增加限制

```javascript
// 查看当前限制
const maxTx = await shibToken.maxTransactionAmount();
console.log("最大交易额:", ethers.utils.formatEther(maxTx));

// 增加限制（仅限所有者）
await shibToken.updateTransactionLimits(
    ethers.utils.parseEther("10000000"), // 新的最大交易额
    ethers.utils.parseEther("50000000")  // 新的最大钱包额
);
```

#### 3. 交易失败："Transaction too frequent"
**解决方案**: 等待冷却时间或减少冷却时间

```javascript
// 查看冷却时间
const cooldown = await shibToken.transactionCooldown();
console.log("冷却时间:", cooldown, "秒");

// 减少冷却时间（仅限所有者）
await shibToken.updateTransactionCooldown(10); // 10秒
```

#### 4. 交易失败："Blacklisted address"
**解决方案**: 从黑名单中移除地址

```javascript
await shibToken.updateBlacklist(address, false);
```

#### 5. 流动性添加失败
**解决方案**: 检查授权和余额

```javascript
// 检查代币余额
const balance = await shibToken.balanceOf(userAddress);
console.log("代币余额:", ethers.utils.formatEther(balance));

// 检查授权额度
const allowance = await shibToken.allowance(userAddress, poolManager.address);
console.log("授权额度:", ethers.utils.formatEther(allowance));

// 重新授权
await shibToken.approve(poolManager.address, ethers.constants.MaxUint256);
```

### 调试工具

#### 事件监听
```javascript
// 监听转账事件
shibToken.on("Transfer", (from, to, amount, event) => {
    console.log(`转账: ${from} -> ${to}, 金额: ${ethers.utils.formatEther(amount)}`);
});

// 监听税费更新事件
shibToken.on("TaxesUpdated", (buyTax, sellTax, event) => {
    console.log(`税率更新: 买入${buyTax}%, 卖出${sellTax}%`);
});

// 监听流动性事件
poolManager.on("LiquidityAdded", (provider, tokenAmount, ethAmount, lpTokens) => {
    console.log(`添加流动性: ${provider}, 代币: ${ethers.utils.formatEther(tokenAmount)}`);
});
```

#### 合约状态查询
```javascript
// 完整状态检查函数
async function checkContractStatus() {
    console.log("=== 合约状态检查 ===");
    
    // 基本信息
    console.log("代币名称:", await shibToken.name());
    console.log("代币符号:", await shibToken.symbol());
    console.log("总供应量:", ethers.utils.formatEther(await shibToken.totalSupply()));
    
    // 税率信息
    const taxInfo = await shibToken.getTaxInfo();
    console.log("买入税:", taxInfo.buyTax_, "%");
    console.log("卖出税:", taxInfo.sellTax_, "%");
    
    // 限制信息
    const limitsInfo = await shibToken.getLimitsInfo();
    console.log("交易已启用:", limitsInfo.tradingEnabled_);
    console.log("最大交易额:", ethers.utils.formatEther(limitsInfo.maxTransactionAmount_));
    console.log("最大钱包额:", ethers.utils.formatEther(limitsInfo.maxWalletAmount_));
    
    // 池统计
    const poolStats = await poolManager.getPoolStats();
    console.log("总流动性提供者:", poolStats.totalProviders_.toString());
    console.log("奖励率:", poolStats.currentRewardRate, "%");
    
    console.log("=== 检查完成 ===");
}

// 调用状态检查
await checkContractStatus();
```
